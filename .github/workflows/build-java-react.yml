# Nombre del flujo de trabajo que verás en la pestaña "Actions" de GitHub
name: Construir Aplicacion Spring y React

# Define cuándo se debe ejecutar este flujo
on:
  push:
    branches: [ main ] # Nombre de la rama principal
    paths:
      - 'frontend/**' # Se activa si hay cambios en el frontend
      - 'backend/**'  # O si hay cambios en el backend

# Define los "trabajos" que se van a ejecutar
jobs:
  build-and-package:
    # El trabajo se llamará "Construir y Empaquetar"
    name: Construir y Empaquetar
    # Usará una máquina virtual de Ubuntu (Linux) para correr los comandos
    runs-on: ubuntu-latest

    # Pasos a ejecutar
    steps:
      # 1. Descarga el código de tu repositorio a la máquina virtual
      - name: Checkout del repositorio
        uses: actions/checkout@v4

      # 2. Configura el entorno de Java (JDK 17)
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin' # Usamos la distribución Temurin

      # 3. Configura el entorno de Node.js (para el frontend)
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22' # O la versión que estés usando
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      # 4. Construye el Frontend
      - name: Instalar dependencias y construir el frontend
        run: |
          cd frontend
          npm install
          npm run build

      # 5. Copia el build del frontend al backend
      - name: Copiar archivos del frontend al backend
        run: |
          mkdir -p backend/src/main/resources/static
          cp -r frontend/dist/* backend/src/main/resources/static/

      # 6. (Paso de seguridad) Da permisos de ejecución al wrapper de Gradle
      - name: Dar permisos de ejecución a Gradle
        run: chmod +x backend/gradlew

      # 7. Construye el Backend (.jar)
      - name: Construir el backend con Gradle
        run: |
          cd backend
          ./gradlew bootJar

      # 8. Sube el .jar final como un "artefacto"
      - name: Subir artefacto (el .jar)
        uses: actions/upload-artifact@v4
        with:
          name: negocio-app-jar # El nombre que tendrá el archivo zip para descargar
          path: backend/build/libs/*.jar # Sube todos los .jar de la carpeta libs